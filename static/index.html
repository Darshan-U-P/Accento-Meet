<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Simple Chat (Mini Meet)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;color:#111;margin:0;padding:18px}
    .app{max-width:900px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px}
    input,button,select,textarea{padding:8px;border-radius:6px;border:1px solid #ddd}
    button{background:#3578f6;color:#fff;border:none;cursor:pointer}
    .layout{display:flex;gap:14px;margin-top:12px}
    .left{flex:1}
    .right{width:260px}
    #chat{height:400px;overflow:auto;border:1px solid #eee;padding:10px;background:#fff;border-radius:6px}
    .msg{margin-bottom:8px}
    .meta{font-size:12px;color:#666}
    .participant{padding:6px;border-radius:6px;margin-bottom:6px;background:#fff;border:1px solid #eee}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h2>Simple Chat</h2>
    </header>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <label>Name: <input id="name" type="text" value="Guest" /></label>
      <label>Room: <input id="room" type="text" value="main" /></label>
      <button id="connect">Connect</button>
      <button id="disconnect" disabled>Disconnect</button>
    </div>

    <div class="layout">
      <div class="left">
        <div id="chat"></div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="message" placeholder="Type message..." style="flex:1" />
          <button id="send" disabled>Send</button>
        </div>
      </div>

      <aside class="right">
        <h4>Participants</h4>
        <div id="participants"></div>
      </aside>
    </div>
  </div>

<script>
let ws = null;
let myId = null;

const nameInput = document.getElementById('name');
const roomInput = document.getElementById('room');
const connectBtn = document.getElementById('connect');
const disconnectBtn = document.getElementById('disconnect');
const chatDiv = document.getElementById('chat');
const participantsDiv = document.getElementById('participants');
const msgInput = document.getElementById('message');
const sendBtn = document.getElementById('send');

function appendMessage(html) {
  const d = document.createElement('div');
  d.className = 'msg';
  d.innerHTML = html;
  chatDiv.appendChild(d);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function renderParticipants(list) {
  participantsDiv.innerHTML = '';
  (list || []).forEach(p => {
    const el = document.createElement('div');
    el.className = 'participant';
    el.innerHTML = `<strong>${escapeHtml(p.name)}</strong><div class="meta">${p.id}</div>`;
    participantsDiv.appendChild(el);
  });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

connectBtn.onclick = () => {
  if (ws) return;
  const name = nameInput.value.trim() || 'Guest';
  const room = roomInput.value.trim() || 'main';
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  const url = `${proto}://${location.host}/ws/${encodeURIComponent(room)}`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    // send join message
    ws.send(JSON.stringify({ type: 'join', name }));
    appendMessage('<div class="meta">Connected — joining...</div>');
    connectBtn.disabled = true;
    disconnectBtn.disabled = false;
  };

  ws.onmessage = (evt) => {
    try {
      const msg = JSON.parse(evt.data);
      handleMsg(msg);
    } catch(e) {
      console.error('invalid message', e);
    }
  };

  ws.onclose = () => {
    appendMessage('<div class="meta">Disconnected from server</div>');
    ws = null;
    connectBtn.disabled = false;
    disconnectBtn.disabled = true;
    sendBtn.disabled = true;
    participantsDiv.innerHTML = '';
  };

  ws.onerror = (e) => console.error('ws error', e);
};

disconnectBtn.onclick = () => {
  if (!ws) return;
  ws.close();
  ws = null;
  connectBtn.disabled = false;
  disconnectBtn.disabled = true;
  sendBtn.disabled = true;
};

sendBtn.onclick = () => {
  const t = msgInput.value.trim();
  if (!t || !ws) return;
  ws.send(JSON.stringify({ type: 'chat', text: t }));
  appendMessage(`<div><strong>[me]</strong> ${escapeHtml(t)}</div>`);
  msgInput.value = '';
};

function handleMsg(msg) {
  switch (msg.type) {
    case 'welcome':
      myId = msg.id;
      appendMessage(`<div class="meta">Welcome — your id: ${msg.id}</div>`);
      renderParticipants(msg.participants);
      sendBtn.disabled = false;
      break;

    case 'participants':
      renderParticipants(msg.participants);
      break;

    case 'participant-joined':
      appendMessage(`<div class="meta">${escapeHtml(msg.name)} joined (${msg.id})</div>`);
      break;

    case 'participant-left':
      appendMessage(`<div class="meta">${escapeHtml(msg.name)} left (${msg.id})</div>`);
      break;

    case 'chat':
      appendMessage(`<div><strong>${escapeHtml(msg.name)}</strong> ${escapeHtml(msg.text)}</div>`);
      break;

    case 'error':
      appendMessage(`<div class="meta" style="color:crimson">Error: ${escapeHtml(msg.message)}</div>`);
      break;

    default:
      console.log('unknown message', msg);
  }
}
</script>
</body>
</html>
