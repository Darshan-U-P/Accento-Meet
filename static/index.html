<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat — Simple Approval Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Simple, minimal UI */
    :root{--bg:#0f1724;--card:#071225;--muted:#9aa4b2}
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#e6eef6;margin:0;padding:16px}
    .wrap{max-width:880px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px}
    input,button{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:var(--card);color:inherit}
    button{background:#6d28d9;border:none;cursor:pointer}
    .row{display:flex;gap:8px;align-items:center;margin-top:12px}
    .main{display:flex;gap:12px;margin-top:12px}
    .left{flex:1}
    .panel{background:var(--card);padding:12px;border-radius:8px}
    #chat{height:360px;overflow:auto;padding:8px;border-radius:6px;background:#081022}
    .msg{margin-bottom:8px}
    .meta{font-size:12px;color:var(--muted)}
    .participants, .pending{margin-top:8px}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h3>Chat — Simple Approval</h3>
      <div class="small">(kept minimal)</div>
    </header>

    <div class="row">
      <label>Name: <input id="name" value="Guest" /></label>
      <label>Room: <input id="room" value="main" /></label>
      <button id="connect">Connect</button>
      <button id="disconnect" disabled>Disconnect</button>
      <div style="flex:1"></div>
      <label class="small">Require approval</label>
      <input id="approvalToggle" type="checkbox" />
    </div>

    <div class="main">
      <div class="left panel">
        <div id="chat"></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <input id="message" placeholder="Type message..." style="flex:1" />
          <button id="send" disabled>Send</button>
        </div>
      </div>

      <aside style="width:260px">
        <div class="panel">
          <div class="small">Participants</div>
          <div id="participants" class="participants"></div>
          <hr style="border:none;height:8px;opacity:0" />
          <div class="small">Pending (host only)</div>
          <div id="pendingList" class="pending"></div>
        </div>
      </aside>
    </div>

    <!-- waiting overlay for pending users -->
    <div id="waiting" class="panel hidden" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:260px;text-align:center;z-index:40">
      <div class="small">Waiting for host approval...</div>
      <div style="margin-top:10px"><button id="leavePending">Leave</button></div>
    </div>
  </div>

<script>
// Minimal client with approval support
let ws=null, myId=null, hostId=null;
const nameEl=document.getElementById('name');
const roomEl=document.getElementById('room');
const connectBtn=document.getElementById('connect');
const disconnectBtn=document.getElementById('disconnect');
const chatEl=document.getElementById('chat');
const participantsEl=document.getElementById('participants');
const pendingEl=document.getElementById('pendingList');
const msgEl=document.getElementById('message');
const sendBtn=document.getElementById('send');
const approvalToggle=document.getElementById('approvalToggle');
const waitingBox=document.getElementById('waiting');
const leavePending=document.getElementById('leavePending');

function esc(s){return String(s||'').replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]||c));}
function addChat(html){const d=document.createElement('div');d.className='msg';d.innerHTML=html;chatEl.appendChild(d);chatEl.scrollTop=chatEl.scrollHeight}
function renderParticipants(list){participantsEl.innerHTML='';(list||[]).forEach(p=>{const n=document.createElement('div');n.textContent=`${p.name} (${p.id})`;participantsEl.appendChild(n)})}
function renderPending(list){pendingEl.innerHTML='';(list||[]).forEach(p=>{const row=document.createElement('div');row.style.display='flex';row.style.justifyContent='space-between';row.style.marginBottom='6px';row.innerHTML=`<div>${esc(p.name)}<div class=\'meta\'>${p.id}</div></div>`;const btns=document.createElement('div');const a=document.createElement('button');a.textContent='Accept';a.onclick=()=>{sendAction('accept',p.id);row.remove()};const r=document.createElement('button');r.textContent='Reject';r.onclick=()=>{if(confirm('Reject '+p.name+'?')){sendAction('reject',p.id);row.remove()}};btns.appendChild(a);btns.appendChild(r);row.appendChild(btns);pendingEl.appendChild(row)})}

function sendAction(action,target,extra={}){if(!ws)return;ws.send(JSON.stringify(Object.assign({type:'action',action,target},extra)))}

connectBtn.onclick=()=>{if(ws) return;const name=nameEl.value||'Guest';const room=roomEl.value||'main';const proto=location.protocol==='https:'?'wss':'ws';ws=new WebSocket(`${proto}://${location.host}/ws/${encodeURIComponent(room)}`);
ws.onopen=()=>{ws.send(JSON.stringify({type:'join',name}));connectBtn.disabled=true;disconnectBtn.disabled=false;addChat('<div class="meta">Connecting…</div>')}
ws.onmessage=e=>{try{const m=JSON.parse(e.data);handle(m)}catch(err){console.error(err)}}
ws.onclose=()=>{addChat('<div class="meta">Disconnected</div>');cleanup()} 
}

disconnectBtn.onclick=()=>{if(ws) ws.close();cleanup()}

sendBtn.onclick=()=>{const t=msgEl.value.trim(); if(!t||!ws) return; ws.send(JSON.stringify({type:'chat',text:t})); addChat(`<strong>[me]</strong> ${esc(t)}`); msgEl.value=''}
approvalToggle.onchange=()=>{ if(!ws){approvalToggle.checked=!approvalToggle.checked;alert('Connect as host to change');return} sendAction('set-approval',null,{value:approvalToggle.checked}) }
leavePending.onclick=()=>{ if(ws) ws.close(); cleanup() }

function handle(msg){switch(msg.type){
  case 'waiting': waitingBox.classList.remove('hidden'); addChat('<div class="meta">You are waiting for approval</div>'); sendBtn.disabled=true; break;
  case 'welcome': waitingBox.classList.add('hidden'); myId=msg.id; hostId=msg.host_id; addChat(`<div class="meta">Welcome — id: ${msg.id}</div>`); renderParticipants(msg.participants); sendBtn.disabled=false; if(msg.room_meta) approvalToggle.checked=!!msg.room_meta.require_approval; if(msg.pending) renderPending(msg.pending); break;
  case 'participants': renderParticipants(msg.participants); break;
  case 'pending': renderPending(msg.pending); break;
  case 'join-request': addChat(`<div class='meta'>Join request: ${esc(msg.participant.name)}</div>`); break;
  case 'participant-joined': addChat(`<div class='meta'>${esc(msg.name)} joined</div>`); break;
  case 'participant-left': addChat(`<div class='meta'>${esc(msg.name)} left</div>`); break;
  case 'chat': addChat(`<strong>${esc(msg.name)}</strong> ${esc(msg.text)}`); break;
  case 'room-meta': if(msg.meta) approvalToggle.checked=!!msg.meta.require_approval; break;
  case 'command': if(msg.cmd==='you-are-rejected'){ addChat('<div class=\'meta\' style=\'color:crimson\'>You were rejected</div>'); if(ws) ws.close(); cleanup() } break;
  case 'error': addChat(`<div class=\'meta\' style=\'color:crimson\'>Error: ${esc(msg.message)}</div>`); break;
  default: console.log('msg',msg)
}}

function cleanup(){ ws=null; myId=null; hostId=null; connectBtn.disabled=false; disconnectBtn.disabled=true; sendBtn.disabled=true; waitingBox.classList.add('hidden'); participantsEl.innerHTML=''; pendingEl.innerHTML=''}

// enter to send
msgEl.addEventListener('keydown',e=>{ if(e.key==='Enter') sendBtn.click() })
</script>
</body>
</html>
